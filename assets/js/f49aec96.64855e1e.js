"use strict";(globalThis.webpackChunkwalrus_docusaurus=globalThis.webpackChunkwalrus_docusaurus||[]).push([[2458],{8150:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"operator-guide/upload-relay","title":"The Walrus Upload Relay","description":"Complete guide to operating Walrus upload relays for facilitating browser-based blob storage with tip configuration and payment systems.","source":"@site/../content/operator-guide/upload-relay.mdx","sourceDirName":"operator-guide","slug":"/operator-guide/upload-relay","permalink":"/docs/operator-guide/upload-relay","draft":false,"unlisted":false,"editUrl":"https://github.com/MystenLabs/walrus/tree/main/docs/../content/operator-guide/upload-relay.mdx","tags":[],"version":"current","frontMatter":{"title":"The Walrus Upload Relay","description":"Complete guide to operating Walrus upload relays for facilitating browser-based blob storage with tip configuration and payment systems.","keywords":["walrus","upload relay","browser storage","tips","relay operations","slivers","client support","public service"]},"sidebar":"docsSidebar","previous":{"title":"Backup and Restore Guide","permalink":"/docs/operator-guide/backup-restore-guide"},"next":{"title":"Staking and Unstaking","permalink":"/docs/usage/stake"}}');var o=t(2714),s=t(8885);const r={title:"The Walrus Upload Relay",description:"Complete guide to operating Walrus upload relays for facilitating browser-based blob storage with tip configuration and payment systems.",keywords:["walrus","upload relay","browser storage","tips","relay operations","slivers","client support","public service"]},l=void 0,a={},d=[{value:"Design",id:"design",level:2},{value:"Outline",id:"outline",level:3},{value:"Upload Relay Operation",id:"upload-relay-operation",level:3},{value:"Paying the Tip",id:"paying-the-tip",level:3},{value:"Sending Data to the Upload Relay",id:"sending-data-to-the-upload-relay",level:3},{value:"Receiving the Certificate",id:"receiving-the-certificate",level:2},{value:"Installation",id:"installation",level:2},{value:"Download the Binary",id:"download-the-binary",level:3},{value:"Docker",id:"docker",level:3},{value:"Build from Source",id:"build-from-source",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Relay-Specific Configuration",id:"relay-specific-configuration",level:3}];function c(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components},{ImportContent:t,Term:i}=n;return t||u("ImportContent",!0),i||u("Term",!0),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(n.p,{children:["A goal of Walrus is to enable dApps to ",(0,o.jsx)(n.code,{children:"store"})," to Walrus from within their end-users\u2019 browsers\nhaving low to moderate machine specifications (mobile devices, low-powered laptops, etc.). This\nbrowser-based scenario is difficult to achieve in practice with an in-browser process that directly\ncommunicates with the ",(0,o.jsx)(i,{lookup:"Storage node",children:"storage nodes"})," due to the high number of network connections required to upload\nall slivers to all shards."]}),"\n",(0,o.jsxs)(n.p,{children:["The upload relay is a downloadable program that community members, Mysten Labs, and/or dApp writers\nthemselves can run on internet-facing hosts to facilitate storing ",(0,o.jsx)(i,{lookup:"Blob",children:"blob"})," slivers onto the storage\nnodes on behalf of the end-users, thus mitigating browser resource consumption and enabling\nweb-based ",(0,o.jsx)(n.code,{children:"store"})," operations."]}),"\n",(0,o.jsxs)(n.admonition,{title:"Public upload relays",type:"tip",children:[(0,o.jsxs)(n.p,{children:["Mysten Labs runs two publicly-available upload relays, one for ",(0,o.jsx)(n.code,{children:"testnet"})," and one for ",(0,o.jsx)(n.code,{children:"mainnet"}),".\nYou can find them at the following addresses:"]}),(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"testnet"}),": ",(0,o.jsx)(n.code,{children:"https://upload-relay.testnet.walrus.space"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"mainnet"}),": ",(0,o.jsx)(n.code,{children:"https://upload-relay.mainnet.walrus.space"})]}),"\n"]})]}),"\n",(0,o.jsx)(n.h2,{id:"design",children:"Design"}),"\n",(0,o.jsx)(n.h3,{id:"outline",children:"Outline"}),"\n",(0,o.jsxs)(n.p,{children:["At a high level, a ",(0,o.jsx)(i,{lookup:"Client",children:"client"})," stores a ","blob"," using an upload relay as follows:"]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["First, the ","client"," locally encodes the ","blob"," and registers it on Sui;"]}),"\n",(0,o.jsxs)(n.li,{children:["then, the ","client"," sends the ","blob"," to the upload relay via an HTTP POST request to the ","blob","-relay\nendpoint (",(0,o.jsx)(n.code,{children:"/v1/blob-upload-relay"}),");"]}),"\n",(0,o.jsxs)(n.li,{children:["the upload relay then encodes the ","blob",", sends the slivers to the ","storage nodes",", collects a storage\nconfirmation certificate, and sends it back to the ","client",";"]}),"\n",(0,o.jsxs)(n.li,{children:["finally, the ","client"," uses the confirmation certificate to certify the ","blob"," on Sui."]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["Therefore, the upload relay ",(0,o.jsx)(n.em,{children:"does not"})," perform any on-chain operation, and only helps clients\ndistribute the slivers of their ","blobs"," to ","storage nodes","."]}),"\n",(0,o.jsx)(n.p,{children:"This flow between clients and the upload relay is already implemented in the Walrus CLI, Rust SDK,\nand TS SDK, and therefore developers do not need to implement it themselves. For completeness, in\nthe following we discuss how the service is implemented, paid for, and used by clients."}),"\n",(0,o.jsx)(n.h3,{id:"upload-relay-operation",children:"Upload Relay Operation"}),"\n",(0,o.jsx)(n.p,{children:"The upload relay can be operated in two ways:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Free service"}),": It accepts simple HTTP POST requests with ","blobs"," from clients, and relays them to\nthe ","storage nodes"," for free."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Paid service"})," (for public relays): In this configuration, the upload relay requires a ",(0,o.jsx)(n.em,{children:"tip"})," to\nrelay a ","blob",". The tip can be used by the relay operator to cover the costs of running the\ninfrastructure and turn a profit on the service. At the moment, we allow a constant tip, and a tip\nthat is linear in the unencoded data size."]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["Upload relays expose a tip-configuration endpoint (",(0,o.jsx)(n.code,{children:"/v1/tip-config"}),") that returns the tipping\nconfiguration. For example:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{\n  "send_tip": {\n    "address": "0x1234...",\n    "kind": {\n    "const": 105\n    }\n  }\n}\n'})}),"\n",(0,o.jsxs)(n.p,{children:["The configuration above specifies that every store operation requires a tip of ",(0,o.jsx)(n.code,{children:"105 MIST"})," (arbitrary\nvalue), paid to the set address (",(0,o.jsx)(n.code,{children:"0x1234.."}),"). Note that this configuration is provided even for free\nupload relays (returning ",(0,o.jsx)(n.code,{children:'"no_tip"'}),")."]}),"\n",(0,o.jsx)(n.h3,{id:"paying-the-tip",children:"Paying the Tip"}),"\n",(0,o.jsx)(n.p,{children:"This step is only necessary if the relay requires a tip."}),"\n",(0,o.jsxs)(n.p,{children:["To pay the tip, the ","client"," proceeds as follows:"]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["it computes the ",(0,o.jsx)(n.code,{children:"blob_digest = SHA256(blob)"})]}),"\n",(0,o.jsxs)(n.li,{children:["it generates a random ",(0,o.jsx)(n.code,{children:"nonce"}),", and hashes it ",(0,o.jsx)(n.code,{children:"nonce_digest = SHA256(nonce)"})]}),"\n",(0,o.jsxs)(n.li,{children:["it computes the ",(0,o.jsx)(n.code,{children:"unencoded_length = blob.len()"})]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["Then, it creates a PTB, where the first input (",(0,o.jsx)(n.code,{children:"input 0"}),") is the ",(0,o.jsx)(n.code,{children:"bcs"})," encoded representation of\n",(0,o.jsx)(n.code,{children:"blob_digest || nonce_digest || unencoded_length"}),". This will later be used by the relay to\nauthenticate the sender of the store request. In the same PTB, the ","client"," transfers the appropriate\ntip amount to the relay\u2019s wallet (also found through the ",(0,o.jsx)(n.code,{children:"/v1/tip-config"})," endpoint). Usually, the\n","client"," would also register the ","blob"," in this transaction. This is not mandatory, and the ","blob"," can be\nregistered in another transaction, but it is commonly convenient and cheaper to perform all these\noperations together."]}),"\n",(0,o.jsxs)(n.p,{children:["Once the transaction is executed, the ","client"," keeps the transaction ID ",(0,o.jsx)(n.code,{children:"tx_id"})," , the ",(0,o.jsx)(n.code,{children:"nonce"}),", and the\n",(0,o.jsx)(n.code,{children:"blob_id"}),", which are required for the next phase."]}),"\n",(0,o.jsx)(n.p,{children:"Note: the relay will enforce a freshness check on the transaction that paid the tip (currently 1h by\ndefault, but each relay can independently configure this)."}),"\n",(0,o.jsx)(n.h3,{id:"sending-data-to-the-upload-relay",children:"Sending Data to the Upload Relay"}),"\n",(0,o.jsxs)(n.p,{children:["See the full OpenAPI spec for the upload relay for the full details\n(",(0,o.jsx)(n.a,{href:"https://github.com/mystenlabs/walrus/tree/main/crates/walrus-upload-relay/upload_relay_openapi.yaml",children:"yaml"}),",\n",(0,o.jsx)(n.a,{href:"https://github.com/mystenlabs/walrus/tree/main/crates/walrus-upload-relay/upload_relay_openapi.html",children:"html"}),")."]}),"\n",(0,o.jsxs)(n.p,{children:["Essentially, the ","client"," sends a POST request to the ",(0,o.jsx)(n.code,{children:"/v1/blob-upload-relay"})," API endpoint on the relay,\ncontaining the bytes of the ","blob"," to be stored in the body."]}),"\n",(0,o.jsx)(n.p,{children:"These additional parameters have to be specified in the URL\u2019s query string:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"blob_id"})," (required): The ",(0,o.jsx)(i,{lookup:"Blob ID",children:"blob ID"})," of the ","blob"," to be stored. Example:\n",(0,o.jsx)(n.code,{children:"blob_id=E7_nNXvFU_3qZVu3OH1yycRG7LZlyn1-UxEDCDDqGGU"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"tx_id"})," (required if the relay requires tip): The transaction ID (Base58 encoded) of the\ntransaction that transferred the TIP to the relay. Example:\n",(0,o.jsx)(n.code,{children:"tx_id=EmcFpdozbobqH61w76T4UehhC4UGaAv32uZpv6c4CNyg"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"nonce"})," (required if the relay requires tip): The ",(0,o.jsx)(n.code,{children:"nonce"}),", the preimage of the hash added to the\ntransaction inputs created above, as a Base64 URL-encoded string without padding.\n",(0,o.jsx)(n.code,{children:"nonce=rw8xIuqxwMpdOcF_3jOprsD9TtPWfXK97tT_lWr1teQ"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"deletable_blob_object"})," (required if the ","blob"," is registered as deletable): If the ","blob"," being\nstored is deletable, then the ","client"," must specify the object ID (as a Hex string) of the ","Blob",". If\nthe ","blob"," is to be stored as a permanent one, this parameter should not be specified. Example:\n",(0,o.jsx)(n.code,{children:"deletable_blob_object=0x56ae1c86e17db174ea002f8340e28880bc8a8587c56e8604a4fa6b1170b23a60"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"encoding_type"})," (optional): The encoding type to be used for the ","blob",". The default value, and at\nthe moment the only value, is ",(0,o.jsx)(n.code,{children:"RS2"}),"."]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"receiving-the-certificate",children:"Receiving the Certificate"}),"\n",(0,o.jsxs)(n.p,{children:["Once the relay is done storing the ","blob",", it will collect the confirmation certificate from the\n","storage nodes","."]}),"\n",(0,o.jsxs)(n.p,{children:["Then, it will send a response to the ","client",", containing the ",(0,o.jsx)(n.code,{children:"blob_id"})," of the stored ","blob",", along with\nthe ",(0,o.jsx)(n.code,{children:"confirmation_certificate"}),". The ","client"," can then use this certificate to certify the ","blob"," on\nchain."]}),"\n",(0,o.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,o.jsx)(n.h3,{id:"download-the-binary",children:"Download the Binary"}),"\n",(0,o.jsxs)(n.p,{children:["If you'd like to download a pre-built binary in order manually run ",(0,o.jsx)(n.code,{children:"walrus-upload-relay"}),", you'll\nneed to download it from ",(0,o.jsx)(n.a,{href:"https://github.com/MystenLabs/walrus/releases",children:"the releases page"}),". Note\nthat ",(0,o.jsx)(n.code,{children:"walrus-upload-relay"})," does not daemonize itself, and requires some supervisor process to ensure\nboot at startup, to restart in the event of failures, etc."]}),"\n",(0,o.jsx)(n.h3,{id:"docker",children:"Docker"}),"\n",(0,o.jsxs)(n.p,{children:["The docker image for ",(0,o.jsx)(n.code,{children:"walrus-upload-relay"})," is available on Docker Hub as\n",(0,o.jsx)(n.code,{children:"mysten/walrus-upload-relay"}),"."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"$ docker run -it --rm mysten/walrus-upload-relay --help\n"})}),"\n",(0,o.jsx)(n.h3,{id:"build-from-source",children:"Build from Source"}),"\n",(0,o.jsxs)(n.p,{children:["Of course, if you'd like to build from sources, that is always an option, as well. The sources for\nthe ",(0,o.jsx)(n.code,{children:"walrus-upload-relay"})," are available on ",(0,o.jsx)(n.a,{href:"https://github.com/MystenLabs/walrus",children:"GitHub"})," in the\n",(0,o.jsx)(n.code,{children:"crates/walrus-upload-relay"})," subdirectory. Running the following from the root of the Walrus repo\nshould get you a working binary."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"$ cargo build --release --bin walrus-upload-relay\n./target/release/walrus-upload-relay --help\n"})}),"\n",(0,o.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,o.jsxs)(n.p,{children:["Notice that ",(0,o.jsx)(n.code,{children:"walrus-upload-relay"})," requires some configuration to get started. Below is an example of\nhow you might place the configuration such that it is reachable when invoking Docker to run the\nrelay. For the sake of the example below, we're assuming that:"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"$HOME/.config/walrus/walrus_upload_relay_config.yaml"})," exists on the host machine and contains the\nconfiguration for the ",(0,o.jsx)(n.code,{children:"walrus-upload-relay"}),", as described ",(0,o.jsx)(n.a,{href:"#relay-specific-configuration",children:"in the configuration\nsection"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"$HOME/.config/walrus/client_config.yaml"})," exists on the host machine and contains ","Walrus client","\nconfiguration as specified ",(0,o.jsx)(n.a,{href:"/docs/usage/setup#configuration",children:"in the CLI setup section"}),"."]}),"\n",(0,o.jsx)(n.li,{children:"Port 3000 is available for the relay to bind to (change this to whichever port you'd like to\nexpose from your host.)"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"$ docker run \\\n    -p 3000:3000 \\\n    -v $HOME/.config/walrus/walrus_upload_relay_config.yaml:/opt/walrus/walrus_upload_relay_config.yaml \\\n    -v $HOME/.config/walrus/client_config.yaml:/opt/walrus/client_config.yaml \\\n    mysten/walrus-upload-relay \\\n    --context testnet \\\n    --walrus-config /opt/walrus/client_config.yaml \\\n    --server-address 0.0.0.0:3000 \\\n    --relay-config /opt/walrus/walrus_upload_relay_config.yaml\n"})}),"\n",(0,o.jsx)(n.h3,{id:"relay-specific-configuration",children:"Relay-Specific Configuration"}),"\n",(0,o.jsxs)(n.p,{children:["Here is an example of the ",(0,o.jsx)(n.code,{children:"walrus-upload-relay"})," configuration file:"]}),"\n",(0,o.jsx)(t,{source:"/crates/walrus-upload-relay/walrus_upload_relay_config_example.yaml",mode:"code"}),"\n",(0,o.jsx)(n.p,{children:"Currently, the options are the following:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"tip_config"}),": The configuration for the tip to be paid. It can be ",(0,o.jsx)(n.code,{children:"!no_tip"}),", for the free service,\nor ",(0,o.jsx)(n.code,{children:"!send_tip"}),", to configure the requested tip. In that case:","\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"address"}),": Contains the hex-encoded address of the upload relay owner, where the tip should be\nsent to."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"kind"}),": The kind of tip that should be paid. It can be ",(0,o.jsx)(n.code,{children:"!const"}),", for a constant tip for each\nstore, or ",(0,o.jsx)(n.code,{children:"!linear"}),", for a linear tip in the unencoded ","blob"," size."]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"tx_freshness_threshold_secs"}),": The maximum amount of time (in seconds) for which a transaction\nthat pays the tip is considered valid."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"tx_max_future_threshold_secs"}),": The maximum amount of time in the future for which the tip-paying\ntransaction is considered valid. This is simply to account for some clock skew."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}function u(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},8885:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>l});var i=t(9378);const o={},s=i.createContext(o);function r(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);